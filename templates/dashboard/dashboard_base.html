{% load static %}
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Dashboard - JHST{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        safelist: [
          "bg-green-50",
          "text-green-500",
          "bg-red-50",
          "text-red-500",
          "bg-blue-50",
          "text-blue-500",
        ],
        theme: {
          extend: {
            colors: {
              primary: "#054D08" /* JHST Green - Deep & Professional */,
              "primary-light": "#0A6D0E",
              accent: "#3b82f6" /* Blue-500 */,
              "bg-light": "#f8fafc" /* Slate-50 */,
              "bg-dark": "#0f172a" /* Slate-900 */,
              "card-light": "#ffffff",
              "card-dark": "#1e293b" /* Slate-800 */,
              "border-light": "#e2e8f0" /* Slate-200 */,
              "border-dark": "#334155" /* Slate-700 */,
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              display: ["Inter", "sans-serif"],
            },
            boxShadow: {
              soft: "0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)",
              card: "0 0 0 1px rgba(0,0,0,0.03), 0 2px 8px rgba(0,0,0,0.04)",
              glass: "0 8px 32px 0 rgba(31, 38, 135, 0.07)",
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }

      /* Sidebar Transitions */
      .sidebar-transition {
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .main-content-transition {
        transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Sidebar Links */
      .sidebar-link {
        position: relative;
        overflow: hidden;
      }

      .sidebar-link::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background-color: #054d08;
        transform: scaleY(0);
        transition: transform 0.2s ease;
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
      }

      .sidebar-link.active::before {
        transform: scaleY(1);
      }

      .sidebar-link.active {
        background-color: rgba(5, 77, 8, 0.08);
        color: #054d08;
      }

      .dark .sidebar-link.active {
        background-color: rgba(255, 255, 255, 0.05);
        color: #4ade80; /* Brighter green for dark mode */
      }
      .dark .sidebar-link.active::before {
        background-color: #4ade80;
      }

      /* Collapsed State Utilities */
      .sidebar-collapsed .link-text,
      .sidebar-collapsed .sidebar-header-text,
      .sidebar-collapsed .section-label,
      .sidebar-collapsed .user-info {
        opacity: 0;
        pointer-events: none;
        display: none; /* Safer for layout */
      }

      .sidebar-collapsed .sidebar-link {
        justify-content: center;
        padding-left: 0;
        padding-right: 0;
      }

      .sidebar-collapsed .sidebar-link svg {
        margin-right: 0;
      }

      /* Glassmorphism utilities */
      .glass {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      }
      .dark .glass {
        background: rgba(30, 41, 59, 0.7);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      /* Hide scrollbar for sidebar */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }

      /* Custom Subtle Scrollbar */
      ::-webkit-scrollbar {
        width: 3px;
        height: 3px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.5); /* Gray-400 with opacity */
        border-radius: 20px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background-color: rgba(107, 114, 128, 0.8); /* Gray-500 */
      }

      /* Firefox */
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
      }
    </style>
  </head>
  <body
    class="bg-[#ededed]/50 dark:bg-bg-dark text-slate-800 dark:text-gray-100 font-sans antialiased min-h-screen flex overflow-hidden"
  >
    <!-- Preloader -->
    <div
      id="page-preloader"
      class="fixed inset-0 z-[60] bg-white dark:bg-bg-dark flex items-center justify-center transition-opacity duration-500"
    >
      <div
        class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary dark:border-white"
      ></div>
    </div>

    <!-- Toast Container -->
    <div
      id="toast-container"
      class="fixed bottom-6 right-6 z-50 flex flex-col space-y-3 pointer-events-none"
    ></div>

    <!-- Hidden Django Messages -->
    <div
      id="django-messages"
      data-messages='[{% for message in messages %}{"tag": "{{ message.tags }}", "text": "{{ message|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'
      class="hidden"
    ></div>

    <!-- Mobile Overlay -->
    <div
      id="sidebar-overlay"
      class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-30 hidden md:hidden transition-opacity duration-300"
    ></div>

    <!-- Sidebar -->
    <aside
      id="sidebar"
      class="bg-white dark:bg-card-dark border-r border-slate-200 dark:border-slate-700 flex flex-col fixed h-full z-40 sidebar-transition w-64 shadow-2xl md:shadow-none transform -translate-x-full md:translate-x-0"
    >
      <!-- Sidebar Header -->
      <div
        class="h-20 flex items-center px-6 border-b border-slate-100 dark:border-slate-800/50"
      >
        <a
          href="{% url 'index' %}"
          class="flex items-center gap-3 overflow-hidden whitespace-nowrap"
        >
          <img
            src="{% static 'assets/images/jhst-logo.png' %}"
            alt="JHST Logo"
            class="h-10 w-auto object-contain flex-shrink-0"
          />
          <span
            class="font-display font-bold text-lg tracking-tight text-primary dark:text-white sidebar-header-text transition-opacity duration-300"
          >
            JHST Journal
          </span>
        </a>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1 no-scrollbar">
        <div class="mb-6">
          <p
            class="px-3 text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 section-label transition-opacity duration-300"
          >
            Menu
          </p>

          <a
            href="{% url 'dashboard' %}"
            class="sidebar-link group flex items-center px-3 py-2.5 text-sm font-medium text-slate-600 dark:text-gray-300 rounded hover:text-primary dark:hover:text-white transition-colors duration-200 mb-1 {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
            title="Dashboard"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-3 text-slate-400 group-hover:text-primary transition-colors"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
              />
            </svg>
            <span class="link-text whitespace-nowrap">Dashboard</span>
          </a>

          <a
            href="{% url 'my_submissions' %}"
            class="sidebar-link group flex items-center px-3 py-2.5 text-sm font-medium text-slate-600 dark:text-gray-300 rounded hover:text-primary dark:hover:text-white transition-colors duration-200 mb-1 {% if request.resolver_match.url_name == 'my_submissions' %}active{% endif %}"
            title="My Submissions"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-3 text-slate-400 group-hover:text-primary transition-colors"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            <span class="link-text whitespace-nowrap">My Submissions</span>
          </a>

          {% if user.is_researcher %}
          <a
            href="{% url 'submit_manuscript' %}"
            class="sidebar-link group flex items-center px-3 py-2.5 text-sm font-medium text-slate-600 dark:text-gray-300 rounded hover:text-primary dark:hover:text-white transition-colors duration-200 mb-1"
            title="Submit Manuscript"
          >
            <span
              class="material-icons text-xl mr-3 group-hover:text-primary transition-colors"
              >upload_file</span
            >
            <span class="link-text whitespace-nowrap">Submit Manuscript</span>
          </a>
          {% endif %}
        </div>

        {% if user.is_editor %}
        <div class="mb-6">
          <p
            class="px-3 text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 section-label transition-opacity duration-300"
          >
            Management
          </p>
          <a
            href="{% url 'manage_volumes' %}"
            class="sidebar-link group flex items-center px-3 py-2.5 text-sm font-medium text-slate-600 dark:text-gray-300 rounded hover:text-primary dark:hover:text-white transition-colors duration-200 mb-1 {% if request.resolver_match.url_name == 'manage_volumes' %}active{% endif %}"
            title="Volumes & Issues"
          >
            <span
              class="material-icons text-xl mr-3 group-hover:text-primary transition-colors"
              >library_books</span
            >
            <span class="link-text whitespace-nowrap"
              >Content (Vol/Issues)</span
            >
          </a>
        </div>
        {% endif %}

        <div class="mb-6">
          <p
            class="px-3 text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 section-label transition-opacity duration-300"
          >
            Settings
          </p>
          <a
            href="{% url 'profile' %}"
            class="sidebar-link group flex items-center px-3 py-2.5 text-sm font-medium text-slate-600 dark:text-gray-300 rounded hover:text-primary dark:hover:text-white transition-colors duration-200 mb-1 {% if request.resolver_match.url_name == 'profile' %}active{% endif %}"
            title="Profile"
          >
            <span
              class="material-icons text-xl mr-3 group-hover:text-primary transition-colors"
              >person</span
            >
            <span class="link-text whitespace-nowrap">Profile</span>
          </a>

          <form action="{% url 'logout' %}" method="post" class="w-full">
            {% csrf_token %}
            <button
              type="submit"
              class="sidebar-link group w-full flex items-center px-3 py-2.5 text-sm font-medium text-slate-600 dark:text-gray-300 rounded hover:bg-red-50 dark:hover:bg-red-900/10 hover:text-red-600 transition-colors duration-200"
              title="Logout"
            >
              <span
                class="material-icons text-xl mr-3 text-slate-400 group-hover:text-red-500 transition-colors"
                >logout</span
              >
              <span class="link-text whitespace-nowrap">Logout</span>
            </button>
          </form>
        </div>
      </nav>

      <!-- User Profile -->
      <div
        class="p-4 border-t border-slate-100 dark:border-slate-800/50 bg-slate-50/50 dark:bg-slate-900/50"
      >
        <div class="flex items-center overflow-hidden whitespace-nowrap">
          <div
            class="h-10 w-10 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm shadow-md flex-shrink-0"
          >
            {{ user.username|slice:":1"|upper }}
          </div>
          <div class="ml-3 user-info transition-opacity duration-300">
            <p class="text-sm font-semibold text-slate-800 dark:text-gray-200">
              {{ user.username }}
            </p>
            <p class="text-xs text-slate-500 truncate max-w-[140px]">
              {{ user.email }}
            </p>
          </div>
        </div>
      </div>

      <!-- Collapse Button (Desktop) -->
      <button
        id="sidebar-collapse-btn"
        class="absolute -right-3 top-24 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-full p-1 shadow-md hidden md:flex items-center justify-center text-slate-500 hover:text-primary transition-transform duration-300 z-50 w-6 h-6"
        aria-label="Toggle Sidebar"
      >
        <span
          class="material-icons text-sm transform transition-transform duration-300"
          id="collapse-icon"
          >chevron_left</span
        >
      </button>
    </aside>

    <!-- Main Content Wrapper -->
    <div
      id="main-content"
      class="flex-1 md:ml-64 flex flex-col h-screen overflow-hidden main-content-transition"
    >
      <!-- Top Header -->
      <header
        class="glass sticky top-0 z-20 h-16 flex items-center justify-between px-6 md:px-8"
      >
        <div class="flex items-center">
          <button
            id="mobile-sidebar-toggle"
            class="md:hidden text-slate-500 hover:text-primary focus:outline-none mr-4"
          >
            <span class="material-icons text-2xl">menu</span>
          </button>
          <h1
            class="text-xl font-display font-semibold text-slate-800 dark:text-white hidden sm:block"
          >
            {% block dashboard_title %}Overview{% endblock %}
          </h1>
        </div>

        <div class="flex items-center space-x-6">
          <a
            href="{% url 'index' %}"
            class="text-sm font-medium text-slate-500 hover:text-primary transition-colors flex items-center gap-1"
          >
            <span class="material-icons text-base">public</span>
            <span class="hidden sm:inline">View Site</span>
          </a>

          <div class="relative notification-bell cursor-pointer">
            <span
              class="material-icons text-slate-500 hover:text-primary transition-colors"
              >notifications_none</span
            >
            <!-- Notification Dot (Example) -->
            <span
              class="absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full border-2 border-white dark:border-slate-900 hidden"
            ></span>
          </div>
        </div>
      </header>

      <!-- Content Area -->
      <main class="p-6 md:p-8 overflow-y-auto flex-1">
        <div class="mx-auto max-w-7xl animate-fade-in-up">
          {% block content %}{% endblock %}
        </div>
      </main>
    </div>

    <script>
      // Elements
      const sidebar = document.getElementById("sidebar");
      const mainContent = document.getElementById("main-content");
      const sidebarOverlay = document.getElementById("sidebar-overlay");

      const mobileToggle = document.getElementById("mobile-sidebar-toggle");
      const collapseBtn = document.getElementById("sidebar-collapse-btn");
      const collapseIcon = document.getElementById("collapse-icon");

      // State
      let isCollapsed = localStorage.getItem("sidebarCollapsed") === "true";
      let isMobileOpen = false;

      // Initialize State
      function initSidebar() {
        if (window.innerWidth >= 768) {
          if (isCollapsed) {
            applyCollapsedState(true);
          } else {
            applyCollapsedState(false);
          }
        } else {
          // Mobile: always start closed
          sidebar.classList.add("-translate-x-full");
          sidebar.classList.remove("sidebar-collapsed"); // Ensure full width when opened on mobile
        }
      }

      function applyCollapsedState(collapsed) {
        if (collapsed) {
          sidebar.classList.add("sidebar-collapsed", "w-20");
          sidebar.classList.remove("w-64");
          mainContent.classList.add("md:ml-20");
          mainContent.classList.remove("md:ml-64");
          collapseIcon.textContent = "chevron_right";
        } else {
          sidebar.classList.remove("sidebar-collapsed", "w-20");
          sidebar.classList.add("w-64");
          mainContent.classList.remove("md:ml-20");
          mainContent.classList.add("md:ml-64");
          collapseIcon.textContent = "chevron_left";
        }
        isCollapsed = collapsed;
        localStorage.setItem("sidebarCollapsed", collapsed);
      }

      function toggleMobileSidebar() {
        isMobileOpen = !isMobileOpen;
        if (isMobileOpen) {
          sidebar.classList.remove("-translate-x-full");
          sidebarOverlay.classList.remove("hidden");
        } else {
          sidebar.classList.add("-translate-x-full");
          sidebarOverlay.classList.add("hidden");
        }
      }

      // Event Listeners
      collapseBtn.addEventListener("click", () => {
        applyCollapsedState(!isCollapsed);
      });

      mobileToggle.addEventListener("click", toggleMobileSidebar);
      sidebarOverlay.addEventListener("click", toggleMobileSidebar);

      // Initialize
      initSidebar();

      // Preloader & Toast Logic (Retained)
      window.addEventListener("load", () => {
        const preloader = document.getElementById("page-preloader");
        if (preloader) {
          preloader.classList.add("opacity-0");
          setTimeout(() => (preloader.style.display = "none"), 500);
        }
      });

      // Toast function
      function showToast(text, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className =
          "pointer-events-auto flex items-center w-full max-w-sm p-4 text-slate-600 bg-white rounded shadow-lg border border-slate-100 dark:bg-slate-800 dark:text-gray-300 dark:border-slate-700 transform transition-all duration-300 translate-x-full";

        let iconColor = "text-blue-500 bg-blue-50";
        let iconName = "info";

        if (type.includes("success")) {
          iconColor = "text-green-500 bg-green-50";
          iconName = "check_circle";
        } else if (type.includes("error")) {
          iconColor = "text-red-500 bg-red-50";
          iconName = "error";
        }

        toast.innerHTML = `
            <div class="flex-shrink-0">
                <div class="inline-flex items-center justify-center h-10 w-10 rounded-full ${iconColor}">
                    <span class="material-icons text-xl">${iconName}</span>
                </div>
            </div>
            <div class="ml-3 flex-1">
                <p class="text-sm font-medium">${text}</p>
            </div>
            <div class="ml-4 flex-shrink-0 flex">
                <button type="button" class="bg-transparent rounded-md inline-flex text-slate-400 hover:text-slate-500 focus:outline-none" onclick="this.closest('div').parentElement.remove()">
                    <span class="sr-only">Close</span>
                    <span class="material-icons text-lg">close</span>
                </button>
            </div>
        `;

        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.remove("translate-x-full"));
        setTimeout(() => {
          toast.classList.add("opacity-0", "translate-x-full");
          setTimeout(() => toast.remove(), 300);
        }, 5000);
      }

      document.addEventListener("DOMContentLoaded", () => {
        const messagesDiv = document.getElementById("django-messages");
        if (messagesDiv && messagesDiv.dataset.messages) {
          try {
            const messages = JSON.parse(messagesDiv.dataset.messages);
            messages.forEach((msg) => showToast(msg.text, msg.tag));
          } catch (e) {
            console.error("Message parse error", e);
          }
        }
      });
    </script>

    <style>
      /* Fade In Animation for Content */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in-up {
        animation: fadeInUp 0.5s ease-out forwards;
      }
    </style>
  </body>
</html>
