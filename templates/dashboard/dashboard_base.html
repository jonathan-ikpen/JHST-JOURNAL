{% load static %}
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Dashboard - JHST{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#054D08" /* JHST Green */,
              accent: "#3b82f6" /* Blue-500 */,
              "bg-light": "#f8fafc",
              "bg-dark": "#0f172a",
              "card-light": "#ffffff",
              "card-dark": "#1e293b",
              "border-light": "#e2e8f0",
              "border-dark": "#334155",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
              body: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      .sidebar-link.active {
        background-color: rgba(5, 77, 8, 0.1);
        color: #054d08;
        border-right: 3px solid #054d08;
      }
      @keyframes wave {
        0%,
        100% {
          height: 16px;
        }
        50% {
          height: 40px;
        }
      }
      .animate-wave {
        animation: wave 1s ease-in-out infinite;
        border-radius: 4px;
        height: 16px;
      }
    </style>
  </head>
  <body
    class="bg-bg-light dark:bg-bg-dark text-gray-900 dark:text-gray-100 font-body antialiased min-h-screen flex"
  >
    <!-- Preloader -->
    <div
      id="page-preloader"
      class="fixed inset-0 z-[60] bg-white flex items-center justify-center transition-opacity duration-500"
    >
      <div
        class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary"
      ></div>
    </div>

    <!-- Toast Container -->
    <div
      id="toast-container"
      class="fixed bottom-5 right-5 z-50 flex flex-col space-y-3 p-4 pointer-events-none"
    ></div>

    <!-- Hidden Django Messages -->
    <div
      id="django-messages"
      data-messages='[{% for message in messages %}{"tag": "{{ message.tags }}", "text": "{{ message|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'
      class="hidden"
    ></div>

    <!-- Mobile Overlay -->
    <div
      id="sidebar-overlay"
      class="fixed inset-0 bg-black/50 z-20 hidden md:hidden glass transition-opacity"
    ></div>

    <!-- Sidebar -->
    <aside
      id="sidebar"
      class="w-64 bg-white dark:bg-card-dark border-r border-border-light dark:border-border-dark flex flex-col fixed h-full z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out"
    >
      <div
        class="h-16 flex items-center px-6 border-b border-border-light dark:border-border-dark"
      >
        <a href="{% url 'index' %}" class="flex items-center space-x-2">
          <img
            src="{% static 'assets/images/jhst-logo.png' %}"
            alt="JHST Logo"
            class="h-12 w-auto"
          />
        </a>
      </div>

      <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
        <p
          class="px-3 text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
        >
          Menu
        </p>

        <a
          href="{% url 'dashboard' %}"
          class="sidebar-link group flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-primary transition {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 mr-3 text-gray-400 group-hover:text-primary transition"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
            />
          </svg>
          Dashboard
        </a>

        {% if user.is_researcher %}
        <a
          href="{% url 'submit_manuscript' %}"
          class="sidebar-link group flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-primary transition"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 mr-3 text-gray-400 group-hover:text-primary transition"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
            />
          </svg>
          Submit Manuscript
        </a>
        {% endif %} {% if user.is_editor %}
        <p
          class="px-3 text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 mt-6"
        >
          Management
        </p>
        <a
          href="{% url 'manage_volumes' %}"
          class="sidebar-link group flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-primary transition {% if request.resolver_match.url_name == 'manage_volumes' %}active{% endif %}"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 mr-3 text-gray-400 group-hover:text-primary transition"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
            />
          </svg>
          Content (Vol/Issues)
        </a>
        {% endif %}

        <p
          class="px-3 text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 mt-6"
        >
          Settings
        </p>
        <a
          href="{% url 'profile' %}"
          class="sidebar-link group flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-primary transition {% if request.resolver_match.url_name == 'profile' %}active{% endif %}"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 mr-3 text-gray-400 group-hover:text-primary transition"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
            />
          </svg>
          Profile
        </a>
        <form action="{% url 'logout' %}" method="post" class="w-full">
          {% csrf_token %}
          <button
            type="submit"
            class="sidebar-link group w-full flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md hover:bg-red-50 dark:hover:bg-red-900/10 hover:text-red-600 transition"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-3 text-gray-400 group-hover:text-red-500 transition"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
              />
            </svg>
            Logout
          </button>
        </form>
      </nav>

      <div class="p-4 border-t border-border-light dark:border-border-dark">
        <div class="flex items-center">
          <div
            class="h-8 w-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm"
          >
            {{ user.username|slice:":1"|upper }}
          </div>
          <div class="ml-3">
            <p class="text-xs font-medium text-gray-700 dark:text-gray-200">
              {{ user.username }}
            </p>
            <p class="text-xs text-gray-500">
              {{ user.get_full_name|default:"Researcher" }}
            </p>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 md:ml-64 flex flex-col min-h-screen">
      <!-- Top Header for Mobile/Context -->
      <header
        class="bg-white dark:bg-card-dark h-16 border-b border-border-light dark:border-border-dark flex items-center justify-between px-6 shadow-sm"
      >
        <div class="md:hidden">
          <!-- Mobile Menu Button -->
          <button
            id="sidebar-toggle"
            class="text-gray-500 hover:text-primary focus:outline-none"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              />
            </svg>
          </button>
        </div>
        <div>
          <h1
            class="text-xl font-display font-bold text-gray-800 dark:text-white hidden md:block"
          >
            {% block dashboard_title %}Overview{% endblock %}
          </h1>
        </div>
        <div class="flex items-center space-x-4">
          <a
            href="{% url 'index' %}"
            class="text-sm font-medium text-gray-500 hover:text-primary"
            >View Journal Site</a
          >
          <div
            class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 cursor-pointer relative notification-bell"
          >
            <!-- Notification Bell -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 text-gray-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
              />
            </svg>
          </div>
        </div>
      </header>

      <div class="p-6 md:p-8 overflow-y-auto">
        {% block content %}{% endblock %}
      </div>
    </main>
    <script>
      // Preloader
      window.addEventListener("load", () => {
        const preloader = document.getElementById("page-preloader");
        if (preloader) {
          preloader.classList.add("opacity-0");
          setTimeout(() => (preloader.style.display = "none"), 500);
        }
      });

      // Navigation Preloader Trigger
      document.addEventListener("click", (e) => {
        const link = e.target.closest("a");
        if (
          link &&
          !link.target &&
          link.href &&
          !link.href.includes("#") &&
          !link.href.startsWith("javascript") &&
          !e.ctrlKey &&
          !e.metaKey
        ) {
          const preloader = document.getElementById("page-preloader");
          if (preloader) {
            preloader.style.display = "flex";
            requestAnimationFrame(() =>
              preloader.classList.remove("opacity-0")
            );
          }
        }
      });

      // Toast Logic
      function showToast(text, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className =
          "pointer-events-auto flex items-center w-full max-w-xs p-4 mb-4 text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800 transform transition-all duration-300 translate-x-full";

        let icon = "";
        if (type.includes("success")) {
          icon = `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg dark:bg-green-800 dark:text-green-200"><span class="material-icons text-sm">check</span></div>`;
        } else if (type.includes("error")) {
          icon = `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-red-500 bg-red-100 rounded-lg dark:bg-red-800 dark:text-red-200"><span class="material-icons text-sm">error</span></div>`;
        } else {
          icon = `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-blue-500 bg-blue-100 rounded-lg dark:bg-blue-800 dark:text-blue-200"><span class="material-icons text-sm">info</span></div>`;
        }

        toast.innerHTML = `
            ${icon}
            <div class="ml-3 text-sm font-normal">${text}</div>
            <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8 dark:text-gray-500 dark:hover:text-white dark:bg-gray-800 dark:hover:bg-gray-700" aria-label="Close" onclick="this.parentElement.remove()">
                <span class="material-icons text-sm">close</span>
            </button>
        `;

        container.appendChild(toast);

        // Slide in
        requestAnimationFrame(() => {
          toast.classList.remove("translate-x-full");
        });

        // Auto remove
        setTimeout(() => {
          toast.classList.add("opacity-0", "translate-x-full");
          setTimeout(() => toast.remove(), 300);
        }, 5000);
      }

      document.addEventListener("DOMContentLoaded", () => {
        const messagesDiv = document.getElementById("django-messages");
        let messages = [];
        if (messagesDiv && messagesDiv.dataset.messages) {
          try {
            messages = JSON.parse(messagesDiv.dataset.messages);
          } catch (e) {
            console.error("Error parsing messages:", e);
          }
        }

        if (messages.length > 0) {
          messages.forEach((msg) => showToast(msg.text, msg.tag));
        }
      });

      const sidebar = document.getElementById("sidebar");
      const sidebarToggle = document.getElementById("sidebar-toggle");
      const sidebarOverlay = document.getElementById("sidebar-overlay");

      function toggleSidebar() {
        sidebar.classList.toggle("-translate-x-full");
        sidebarOverlay.classList.toggle("hidden");
      }

      sidebarToggle.addEventListener("click", toggleSidebar);
      sidebarOverlay.addEventListener("click", toggleSidebar);
    </script>
  </body>
</html>
